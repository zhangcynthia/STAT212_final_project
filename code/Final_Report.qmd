---
title: "Public Transportation Accessibility in Twin Cities"
author: "Tina Chen, Shirley Jiang, Cynthia Zhang"
date: "`r format(Sys.Date(),'%e %B, %Y')`"
format: 
  html:
    self-contained: true
editor: visual
---

```{r, echo = FALSE, results = FALSE, message = FALSE, warning=FALSE}
source('cleaning.R')
```

## Introduction

## Motivation

## Data Resource

In this project, we are using multiple data sources. We extract the data of daily

## Demographic and Stops Distribution

### Overview

```{r echo=FALSE}
ggplot() +
  geom_sf(data = census2023, fill = "white") +
  geom_sf(data = stops_sf_county, size = 0.1, color = "blue") +
  theme_void() +
  labs(title = "Bus Stops Distribution")
```


```{r echo=FALSE}
New_name <- c("Population","Median Income", "White ", "Black <br> or African american", "American Indian & <br> Alaska Native ", "Asian ", "Native Hawaiian \n Other Pacific Islander ", "School", "Job")

m <- list()
for (I in 1:9) {
  m[[I]] <- mapview(census2023, zcol = name[I],legend = TRUE,layer.name = New_name[I])
}


do.call(leafsync::sync, c(m[c(1:4, 6, 9)], list(ncol = 3)))

```

From the bus stops distribution map above, we can observe that the locations of bus stops mainly cluster at downtown Saint Paul and downtown Minneapolis. And by looking at the demographic factors, we can roughly conclude that the tracts close to downtown have lower median income and more people of color than the tract close to the edge. Although the maps are quite visually appealing, there isn't enough information we can extract from them.

### Regressions

```{r echo=FALSE, warning=FALSE}
cleaned_stops_census <- clean_names(stops_census_join_sum)

model <- lm(number_of_stops ~ population+median_income + white_alone + black_or_african_american_alone+asian_alone + american_indian_and_alaska_native_alone + native_hawaiian_and_other_pacific_islander_alone + total_jobs, cleaned_stops_census)

par(mfrow = c(2, 2))

cooksD <- cooks.distance(model)
influential <- cooksD[(cooksD > (3 * mean(cooksD, na.rm = TRUE)))]
outlier <- rep(0, cleaned_stops_census%>% nrow() )
outlier[as.numeric(names(influential)) ] <- 1
outlier_info <- cleaned_stops_census %>% cbind(outlier = outlier) %>% filter(outlier == 1)

outlier_info_sf <- st_as_sf(outlier_info)

ggplot()+
  geom_sf(data = census2023, fill = "white")+
  geom_sf(data = outlier_info_sf, fill = "red")+
  geom_sf(data = stops_sf_county, color = "green", size = 0.1, alpha = 0.3) +
  labs(title = "Outliers Distribution") +
  theme_void()

cleaned_stops_census <- cleaned_stops_census %>% filter(!geoid %in% outlier_info$geoid)
```


```{r echo=FALSE, warning=FALSE}
columns_to_iterate <- c("population", "median_income", "white_alone", "black_or_african_american_alone", "asian_alone", "american_indian_and_alaska_native_alone", "native_hawaiian_and_other_pacific_islander_alone", "number_school", "total_jobs")

correlation_values <- vector("list", length = 9)

for (col_name in columns_to_iterate) {
# calculate correlation values
  cor_value <- cor(cleaned_stops_census[[col_name]], cleaned_stops_census$number_of_stops, use = "complete.obs")
# confidence intervals
  mod_formula_str <- str_c("number_of_stops", "~", col_name)
  mod_form <- as.formula(mod_formula_str)
  mod <- lm(mod_form, data = cleaned_stops_census)
  ci <- confint(mod, level = 0.95)
# table of data
  correlation_values[[col_name]] <- tibble(
    variable = col_name,
    slope = mod$coefficients[variable],
    ci_lower = ci[variable, "2.5 %"],
    ci_upper = ci[variable, "97.5 %"]
  )
}

correlation_df <- bind_rows(correlation_values)
knitr::kable(correlation_df, format = "html")


## zoom in 
correlation_df[-c(6,7,8),] %>% 
  ggplot(aes(x = factor(variable, level = correlation_df$variable), y = slope))+
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.2)+
    geom_point(size = 2)+
  labs(x = "Strength of Different Variables in Relation to Number of Stops")+
  theme_minimal()+
  geom_hline( yintercept = 0, color = "red")+
  scale_x_discrete(label = c("population","median \n income", "white \n alone", "black or \n african american", "asian ", "total job"))

# education
correlation_df[8,] %>% 
  ggplot(aes(x = factor(variable, level = correlation_df$variable), y = slope))+
  geom_errorbar(aes(ymin = ci_lower, ymax = ci_upper), width = 0.2)+
    geom_point(size = 2)+
  labs(x = "Strength of Different Variables in Relation to Number of Stops")+
  theme_minimal()+
  geom_hline( yintercept = 0, color = "red")+
  scale_x_discrete(label = c("population","median \n income", "white \n alone", "black or \n african american", "asian ", " total job"))
```

To gain a deeper understanding of how each factor influences the total number of stops per tract, we build 7 linear regression models. From these models, we obtained coefficients for each factor along with their 95% confidence intervals. We then created visualizations to better illustrate these results.

Based on the first plot, we observe a positive correlation between the number of schools and the number of stops. To be more specific, we are 95% confident that adding an additional school in a tract would result in 4-7 more bus stops.

According for the second plot, we find that population, White alone, Black or African American, and total jobs all have a positive correlation, while median income has a negative correlation. Regarding Asian, since its confidence interval crosses 0, we are uncertain about its correlation.


## Pre-Covid and Post-Covid Comparison

To answer our second broad question, we summarized the ridership and number of routes Metro Transit has before, during, and after the pandemic to do the comparison. Here, we treated ridership as people's demand to public transportation and the number of routes as the supply. Noted that those two variables are mutually related.

### Ridership (Demand)

```{r echo=FALSE}
used_ridership_all %>% 
  group_by(nYear) %>%
  mutate(Total_Riders = sum(Total_Riders,na.rm = TRUE)) %>% 
  ggplot(aes(x=nYear, y=Total_Riders))+
  geom_point() +
  geom_line()+
  labs(x = "Year", y = "Total Riders", title = "Ridership Trend Before and After Covid") +
  theme_classic()
```

First, we look at the demand of public transportation. From our visualizations above, by looking at the total ridership across the years, we can see that there was a significant drop in the ridership from year 2019 to year 2021. This is align with the fact that during pandemic, people switch to online working or drive to work to avoid being infected in public. Starting from year 2021, the total ridership keep increasing as people back to working on-site. But, even until now, the ridership haven't recovered to the pre-Covid level.

```{r echo=FALSE}
weekends_weekdays %>% 
  ggplot(aes(x= nYear, y = Total_Riders)) +
  geom_point()+
  geom_line()+
  facet_wrap(~Schedule) +
  labs(x = "Year", y = "Total Riders", title = "Weekday and Weekend Ridership Comparison") +
  theme_classic()
```

If we looking at the ridership in weekdays and weekends respectively, we can observe that during the pandemic, the ridership in weekdays has been greater affected as that in weekends stayed relatively stable. This is consistent with our previous finding that people who take public transportation to work is the group that have been affected the most.

### Route (Supply)

```{r echo=FALSE, message=FALSE, warning=FALSE}
used_ridership_all %>% 
  distinct(nYear,Route) %>% 
  group_by(nYear) %>% 
  mutate(nRoute = n()) %>% 
  ggplot(aes(x=nYear, y= nRoute)) +
  geom_line() +
  geom_point() +
  labs(x = "Year", y = "Number of routes", title = "Change in Number of Routes Provided") +
  theme_classic()

used_ridership_all %>%
  group_by(nYear, rte_class) %>%
  summarise(cnt = n_distinct(Route)) %>% 
  filter(rte_class != "Support") %>% 
  ggplot(aes(x = nYear, y = cnt)) +
  geom_point() +
  geom_line() +
  facet_wrap(~rte_class, labeller = labeller(rte_class = c("CommExp" = "Commuter Express", "CommRai" = "Commuter Rail", "CoreLoc" = "Core Local", "SuburbL" = "Suburb Local"))) +
  labs(x = "Year", y = "number of routes", title = "Number of Route Change Across Route Types") +
  theme_classic()
```

Then, we look into the supply side of public transportation. By looking at the total number of routes provided, we observe a sharp fall from year 2020 to year 2021 and the number is keep decreasing until now. This shows that, as the riders choose not to ride the public transportation, the company was also shutting down the routes. It could because the lack of riders and drivers. Even though the pandemic has past, the number of routes hasn't recovered. 

Then we dig into each type of routes respectively. Metro Transit has classified all the routes into several types. BRT is the short for bus rapid transit, Commuter Express are the routes for commuting only during weekdays, Commuter Rail is specific for the North Star Line, Core Local are the major routes distributed around the center of cities, LRT is the short for light rail transit which specific for Green Line and Blue Line, and Suburb Local are the routes located at the edge of cities. From the plots above, the number of Commuter Express routes has a sharp drop during the pandemic and the number of Core Local routes also have a significant decrease, while the other types of routes are relatively stable. The visualizations above shows that people who do public transportation commuting and who live close to cities centers have been affected the most.

## Limitations

## Conclusion
